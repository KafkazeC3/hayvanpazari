// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Kullanıcı modeli
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  name          String
  phone         String
  avatar        String?
  type          String    @default("INDIVIDUAL") // INDIVIDUAL, BUSINESS
  
  // Konum bilgileri
  city          String
  district      String
  
  // Doğrulama ve durum
  isVerified    Boolean   @default(false)
  isActive      Boolean   @default(true)
  isAdmin       Boolean   @default(false)
  
  // Puanlama
  rating        Float     @default(0)
  reviewCount   Int       @default(0)
  
  // İlişkiler
  listings      Listing[]
  favorites     Favorite[]
  messagesSent  Message[] @relation("SentMessages")
  messagesReceived Message[] @relation("ReceivedMessages")
  reviews       Review[]
  
  // Zaman damgaları
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  
  @@map("users")
}

// Kategori modeli
model Category {
  id            String    @id @default(uuid())
  name          String    @unique
  slug          String    @unique
  description   String?
  icon          String    @default("Cow")
  image         String?
  order         Int       @default(0)
  isActive      Boolean   @default(true)
  
  // İlişkiler
  subcategories Subcategory[]
  listings      Listing[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("categories")
}

// Alt kategori modeli
model Subcategory {
  id            String    @id @default(uuid())
  name          String
  slug          String
  categoryId    String
  
  // İlişkiler
  category      Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  listings      Listing[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([categoryId, slug])
  @@map("subcategories")
}

// İlan modeli
model Listing {
  id            String    @id @default(uuid())
  title         String
  description   String
  price         Int
  currency      String    @default("TRY")
  
  // Kategori ilişkileri
  categoryId    String
  category      Category  @relation(fields: [categoryId], references: [id])
  subcategoryId String?
  subcategory   Subcategory? @relation(fields: [subcategoryId], references: [id])
  
  // Konum
  city          String
  district      String
  fullAddress   String?
  
  // Görseller - JSON array olarak saklanacak
  images        String
  
  // Durum
  status        String    @default("ACTIVE") // ACTIVE, PASSIVE, SOLD, PENDING, REJECTED
  isFeatured    Boolean   @default(false)
  isApproved    Boolean   @default(false)
  
  // İstatistikler
  viewCount     Int       @default(0)
  favoriteCount Int       @default(0)
  
  // İlişkiler
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  favorites     Favorite[]
  features      ListingFeature[]
  messages      Message[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  expiresAt     DateTime?
  
  @@index([status, isApproved])
  @@index([categoryId])
  @@index([city])
  @@index([userId])
  @@index([createdAt])
  @@map("listings")
}

// İlan özellikleri
model ListingFeature {
  id            String    @id @default(uuid())
  key           String
  label         String
  value         String
  listingId     String
  listing       Listing   @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  @@map("listing_features")
}

// Favoriler
model Favorite {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  listingId     String
  listing       Listing   @relation(fields: [listingId], references: [id], onDelete: Cascade)
  createdAt     DateTime  @default(now())
  
  @@unique([userId, listingId])
  @@map("favorites")
}

// Mesajlar
model Message {
  id            String    @id @default(uuid())
  content       String
  senderId      String
  sender        User      @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId    String
  receiver      User      @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  listingId     String?
  listing       Listing?  @relation(fields: [listingId], references: [id], onDelete: SetNull)
  
  // Durum
  isRead        Boolean   @default(false)
  readAt        DateTime?
  
  // İlişkili mesaj (yanıt için)
    parentId      String?
  parent        Message?  @relation("MessageReplies", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies       Message[] @relation("MessageReplies")
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([senderId, receiverId])
  @@index([listingId])
}

// Değerlendirmeler (Yorum ve puan)
model Review {
  id            String    @id @default(uuid())
  rating        Int       @default(5)
  comment       String?
  
  // İlişkiler
  reviewerId    String
  reviewer      User      @relation(fields: [reviewerId], references: [id], onDelete: Cascade)
  
  // Kim için yapıldı
  targetId      String
  
  // İlişkili ilan (varsa)
  listingId     String?
  
  isApproved    Boolean   @default(false)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("reviews")
}

// Sistem ayarları (admin için)
model Setting {
  id            String    @id @default(uuid())
  key           String    @unique
  value         String
  description   String?
  updatedAt     DateTime  @updatedAt
  
  @@map("settings")
}
